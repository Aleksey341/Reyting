# Загрузка данных через вкладку "Загрузка данных"

Теперь вы можете загружать официальные данные методологии (16 критериев) прямо через веб-интерфейс в формате **CSV или Excel (.xlsx)**.

## Способ 1: Загрузить Excel файл (рекомендуемо)

### Требования к Excel файлу

Система поддерживает **ДВА формата**:

**Формат 1: Несколько листов (одна страница = один критерий)**

Ваш текущий формат! Каждый лист имеет:
- **Название листа:** Название критерия (например, "Выполнение задач АГП", "Позиционирование главы МО")
- **Первая колонка:** "Муниципалитет" - названия МО
- **Вторая колонка:** Числовое значение (оценка по этому критерию)

Пример структуры листов:

Лист "Выполнение задач АГП":
```
| Муниципалитет | Значение |
|---|---|
| Липецк | 3 |
| Елец | 4 |
```

Лист "Позиционирование главы МО":
```
| Муниципалитет | Значение |
|---|---|
| Липецк | 5 |
| Елец | 4 |
```

**Маппинг названий листов на коды:**

PUBLIC критерии (pub_1 до pub_9):
- pub_1 → "Оценка поддержки руководства об"
- pub_2 → "Выполнение задач АГП"
- pub_3 → "Позиционирование главы МО"
- pub_4 → "Проектная деятельность"
- pub_5 → "Вовлеченность молодежи _Доброво" (Добровольчество)
- pub_6 → "Вовлеченность молодежи _Движени" (Движение Первых)
- pub_7 → "Личная работа главы с ветеранам" (Ветераны СВО)
- pub_8 → "Кадровый управленческий резерв"
- pub_9 → "Работа с грантами"

CLOSED критерии (closed_1 до closed_8):
- closed_1 → "Партийная принадлежность сотруд" (сотрудников администрации)
- closed_2 → "Распределение мандатов"
- closed_3 → "Показатели АГП _Уровень_"
- closed_4 → "Показатели АГП _Качество_"
- closed_5 → "Экономическая привлекательность"
- closed_6 → "Личная работа главы с ветеранам" (для ветеранов)
- closed_7 → "Партийная принадлежность ветера" (ветеранов)
- closed_8 → "Участие в проекте _Гордость Лип"

PENALTY критерии (pen_1, pen_2, pen_3):
- pen_1 → "Конфликты с региональной власть"
- pen_2 → "Внутримуниципальные конфликты"
- pen_3 → "Данные правоохранительных орган"

---

**Формат 2: Один лист со всеми колонками**

Альтернативный формат (если захотите переделать):
- **Первая колонка:** "Муниципалитет" - названия МО
- **Остальные колонки:** Официальные коды критериев (pub_1, pub_2, ... closed_1, ... pen_1 и т.д.)
- **Данные:** Числовые значения баллов

### Шаг 1: Загрузить Excel файл

1. Перейдите на вкладку **"Загрузка данных"**
2. Выберите **"Официальная методология (16 критериев)"**
3. Выберите месяц периода (например, 2024-01)
4. **Выберите Excel файл (.xlsx)** - системаавтоматически определит формат
5. Нажмите **"Загрузить все файлы"**

### Шаг 2: Проверить результаты

После загрузки данные автоматически:
- Создадут официальные 16 критериев (если их нет)
- Загрузят 360 записей (20 МО × 18 критериев)
- Рассчитают агрегированные баллы
- Определят зоны риска

Перейдите на вкладку **"Рейтинг"** и нажмите **Ctrl+F5** для полной перезагрузки.

---

## Способ 2: Получить шаблон CSV

### Шаг 1: Получить шаблон CSV
```bash
curl -s "https://reyting-alex1976.amvera.io/api/import/official-methodology-template" \
  | python3 -c "import sys, json; data = json.load(sys.stdin); print(data['content'])" > template.csv
```

Или просто откройте в браузере:
```
https://reyting-alex1976.amvera.io/api/import/official-methodology-template
```

Скопируйте содержимое из поля `content` в файл `data.csv`.

### Шаг 2: Заполните CSV данными

Шаблон будет выглядеть так:

```csv
Муниципалитет,pub_1,pub_2,pub_3,pub_4,pub_5,pub_6,pub_7,pub_8,pub_9,closed_1,closed_2,closed_3,closed_4,closed_5,closed_6,closed_7,closed_8,pen_1,pen_2,pen_3
Липецк,3,5,3,3,3,3,3,3,3,6,4,5,5,3,3,6,2,-3,-3,-5
Елец,2,4,3,2,2,2,2,2,2,5,3,4,4,2,2,5,1,-2,-2,-4
Воловский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-3
...
```

**Описание столбцов:**

- `Муниципалитет` - название муниципалитета (20 строк уже предзаполнены)
- `pub_1` ... `pub_9` - оценки по ПУБЛИЧНЫМ критериям (0-5 баллов)
- `closed_1` ... `closed_8` - оценки по ЗАКРЫТЫМ критериям (0-6 баллов)
- `pen_1`, `pen_2`, `pen_3` - штрафные баллы (отрицательные значения)

### Шаг 3: Загрузить CSV через веб-интерфейс

1. Перейдите на вкладку **"Загрузка данных"**
2. Выберите **"Официальная методология (16 критериев)"**
3. Выберите месяц периода (например, 2024-01)
4. Загрузите файл CSV
5. Нажмите **"Загрузить все файлы"**

Система автоматически:
- Проверит формат данных
- Создаст официальные 16 критериев (если их нет)
- Загрузит все 360 записей (20 МО × 18 критериев)
- Рассчитает агрегированные баллы (сумма PUBLIC, сумма CLOSED, штрафы)
- Определит зоны риска (Зелёная/Жёлтая/Красная)

### Шаг 4: Проверить результаты

После загрузки перейдите на вкладку **"Рейтинг"** и нажмите **Ctrl+F5** (полная перезагрузка).

Вы должны увидеть:
- Реальные баллы вместо нулей
- Зоны риска с цветовой кодировкой
- Сортировку по общему баллу

## Пример минимального CSV

```csv
Муниципалитет,pub_1,pub_2,pub_3,pub_4,pub_5,pub_6,pub_7,pub_8,pub_9,closed_1,closed_2,closed_3,closed_4,closed_5,closed_6,closed_7,closed_8,pen_1,pen_2,pen_3
Липецк,3,5,3,3,3,3,3,3,3,6,4,5,5,3,3,6,2,-3,-3,-5
Елец,3,4,3,3,3,2,3,3,3,5,3,4,4,2,2,5,1,-2,-2,-3
Воловский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Грязянский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Данковский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Добринский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Добровский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Долгоруковский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Елецкий,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Задонский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Измалковский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Краснинский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Лебедянский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Лев-Толстовский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Становлянский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Тербунский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Усманский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Хлевенский,2,3,2,2,2,2,2,2,2,4,3,3,3,2,2,4,1,-1,-1,-2
Чаплыгинский,3,5,3,3,3,3,3,3,3,6,4,5,5,3,3,6,2,-3,-3,-5
```

## Как работает агрегация

После загрузки 360 записей (18 критериев × 20 МО), система автоматически рассчитывает итоги:

```
Для каждого муниципалитета:

1. score_public = SUM(pub_1 + pub_2 + ... + pub_9)
2. score_closed = SUM(closed_1 + closed_2 + ... + closed_8)
3. score_penalties = SUM(pen_1 + pen_2 + pen_3)
4. score_total = (score_public + score_closed) / 2 + score_penalties
5. zone = 'Зелёная' если score_total >= 53
         'Жёлтая'  если score_total >= 29
         'Красная' если score_total < 29
```

## Проверка данных

После загрузки вы можете проверить статус базы:

```bash
curl -s "https://reyting-alex1976.amvera.io/api/admin/db-status" | python3 -m json.tool
```

Должно быть:
- `total_indicators`: 20 (официальных критериев)
- `fact_indicators_records`: 360 (20 МО × 18 критериев)
- Данные в API должны отображать реальные баллы

## Если что-то пошло не так

### Ошибка: "Муниципалитет не найден"
- Проверьте, что названия муниципалитетов в CSV совпадают с базой
- Используйте 20 муниципалитетов из шаблона

### Ошибка: "Критерий не найден"
- Убедитесь, что используются коды: pub_1, pub_2, ... closed_1, closed_2, ... pen_1, pen_2, pen_3
- Все 16 критериев будут созданы автоматически при первой загрузке

### Баллы не рассчитались
- Перейдите на вкладку "Загрузка данных"
- Нажмите **Ctrl+F5** для полной перезагрузки браузера
- Если данные всё ещё не показываются, проверьте логи сервера

## Контакты

Если есть вопросы по формату CSV или загрузке, создайте issue на GitHub.
