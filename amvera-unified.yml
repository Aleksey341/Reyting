# ==============================================================================
# Amvera Configuration - Unified Frontend + Backend Deployment
# ==============================================================================
# Архитектура: Единое приложение
#   - FastAPI backend (Port 80)
#   - Раздает статику React из /app/static
#   - Обрабатывает API запросы на /api/*
#   - Один контейнер, один домен, без CORS
# ==============================================================================

version: "1"

app:
  name: reyting-unified
  description: "Reyting Dashboard - Unified Frontend + Backend"
  runtime: docker

build:
  # Используем единый Dockerfile
  dockerfile: Dockerfile.unified
  context: .

run:
  # FastAPI слушает на порту 80
  containerPort: 80

  # Переменные окружения
  env:
    # Database connection
    - name: DATABASE_URL
      value: "postgresql://reyting_user:YOUR_PASSWORD@amvera-alex1976-cnpq-reyting-mo-rw:5432/reytingdb"

    # Backend config
    - name: DEBUG
      value: "False"

    - name: API_TITLE
      value: "Reyting Dashboard API"

    - name: PYTHONUNBUFFERED
      value: "1"

    # Static files directory
    - name: STATIC_DIR
      value: "/app/static"

    # CORS не требуется (same-origin)
    - name: ALLOWED_ORIGINS
      value: "*"

  # Ресурсы контейнера
  resources:
    memory: "1Gi"
    cpu: "0.5"

  # Health check
  healthcheck:
    path: /health
    interval: 30
    timeout: 10
    successThreshold: 1
    failureThreshold: 3

# Домены
domains:
  - host: reyting-alex1976.amvera.io
    routes:
      - path: /
        port: 80

# Логирование
logging:
  level: INFO
  format: text
