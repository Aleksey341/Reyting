-- Migration: Recreate indicators with proper codes (pm_01, ca_01, dev_01, pen_01)
-- This fixes the issue where imported CSV created indicators with wrong codes

BEGIN;

-- Step 1: Drop foreign key constraints temporarily
ALTER TABLE fact_indicator DROP CONSTRAINT IF EXISTS fact_indicator_ind_id_fkey;
ALTER TABLE map_scale DROP CONSTRAINT IF EXISTS map_scale_ind_id_fkey;

-- Step 2: Delete old indicators created during CSV import (keep the data references for now)
-- Keep indicators with proper codes (pm_*, ca_*, dev_*)
DELETE FROM dim_indicator
WHERE code NOT LIKE 'pm_%'
  AND code NOT LIKE 'ca_%'
  AND code NOT LIKE 'dev_%'
  AND code NOT LIKE 'pen_%';

-- Step 3: Verify proper indicators exist, if not create them
INSERT INTO dim_indicator (code, name, block, description, unit, is_public, weight)
VALUES
    -- Блок 1: Политический менеджмент (9 критериев)
    ('pm_01', 'Оценка поддержки руководства области', 'Политический менеджмент', 'Уровень поддержки главой МО региональной администрации', 'баллы', true, 1.0),
    ('pm_02', 'Выполнение задач АГП', 'Политический менеджмент', 'Выполнение задач Аппарата Губернатора', 'баллы', true, 1.0),
    ('pm_03', 'Позиционирование главы МО', 'Политический менеджмент', 'Статус и видимость главы МО в политическом процессе', 'баллы', true, 1.0),
    ('pm_04', 'Проектная деятельность', 'Политический менеджмент', 'Реализация федеральных и региональных проектов', 'баллы', true, 1.0),
    ('pm_05', 'Партийная принадлежность сотрудников', 'Политический менеджмент', 'Партийная принадлежность сотрудников администрации МО', 'баллы', false, 1.0),
    ('pm_06', 'Распределение мандатов', 'Политический менеджмент', 'Распределение парламентских мандатов', 'баллы', false, 1.0),
    ('pm_07', 'Показатели АГП (Уровень)', 'Политический менеджмент', 'Уровень выполнения показателей АГП', 'баллы', false, 1.0),
    ('pm_08', 'Показатели АГП (Качество)', 'Политический менеджмент', 'Качество выполнения показателей АГП', 'баллы', false, 1.0),
    ('pm_09', 'Экономическая привлекательность МО', 'Политический менеджмент', 'Уровень экономической привлекательности МО', 'баллы', false, 1.0),

    -- Блок 2: Забота и внимание (4 критерия)
    ('ca_01', 'Вовлеченность молодежи (Добровольчество)', 'Забота и внимание', 'Уровень вовлеченности молодежи в добровольческую деятельность', 'баллы', true, 1.0),
    ('ca_02', 'Вовлеченность молодежи (Движение Первых)', 'Забота и внимание', 'Уровень вовлеченности молодежи в Движение Первых', 'баллы', true, 1.0),
    ('ca_03', 'Личная работа главы с ветеранами СВО', 'Забота и внимание', 'Уровень личного взаимодействия главы с ветеранами СВО', 'баллы', true, 1.0),
    ('ca_04', 'Партийная принадлежность ветеранов СВО', 'Забота и внимание', 'Партийная принадлежность ветеранов СВО', 'баллы', false, 1.0),

    -- Блок 3: Развитие кадрового и проектного потенциала (3 критерия)
    ('dev_01', 'Кадровый управленческий резерв', 'Развитие кадрового и проектного потенциала МО', 'Наличие и развитие управленческого кадрового резерва', 'баллы', true, 1.0),
    ('dev_02', 'Работа с грантами', 'Развитие кадрового и проектного потенциала МО', 'Успешность участия в грантовых программах', 'баллы', true, 1.0),
    ('dev_03', 'Участие в проекте «Гордость Липецкой земли»', 'Развитие кадрового и проектного потенциала МО', 'Участие и результаты в проекте «Гордость Липецкой земли»', 'баллы', false, 1.0),

    -- Штрафные критерии (3)
    ('pen_01', 'Конфликты с региональной властью', 'Штрафные критерии', 'Наличие конфликтов с органами региональной власти', 'баллы', true, 1.0),
    ('pen_02', 'Внутримуниципальные конфликты', 'Штрафные критерии', 'Наличие конфликтов внутри муниципального образования', 'баллы', true, 1.0),
    ('pen_03', 'Данные правоохранительных органов', 'Штрафные критерии', 'Информация из правоохранительных органов', 'баллы', true, 1.0)
ON CONFLICT (code) DO NOTHING;

-- Step 4: Re-add foreign key constraints
ALTER TABLE fact_indicator ADD CONSTRAINT fact_indicator_ind_id_fkey
    FOREIGN KEY (ind_id) REFERENCES dim_indicator(ind_id);

ALTER TABLE map_scale ADD CONSTRAINT map_scale_ind_id_fkey
    FOREIGN KEY (ind_id) REFERENCES dim_indicator(ind_id);

-- Verification
SELECT COUNT(*) as total_indicators FROM dim_indicator;
SELECT COUNT(DISTINCT code) as unique_codes FROM dim_indicator;
SELECT code, name FROM dim_indicator ORDER BY code;

COMMIT;
