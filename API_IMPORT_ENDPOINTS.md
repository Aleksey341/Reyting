# API Endpoints –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –º–µ—Ç–æ–¥–∏–∫–∏

## ‚úÖ –ï–î–ò–ù–´–ô –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô –≠–ù–î–ü–û–ò–ù–¢ (Primary)

### `POST /api/data-import/import-official-methodology`

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ï–¥–∏–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –º–µ—Ç–æ–¥–∏–∫–µ. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—é —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö" https://reyting-alex1976.amvera.io/import

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `file` (multipart/form-data): CSV –∏–ª–∏ Excel —Ñ–∞–π–ª (.xlsx, .xls, .csv)
- `period_month` (query string): –ü–µ—Ä–∏–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2024-01)

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã**:

#### 1. CSV —Ñ–∞–π–ª (pre-calculated scores)
```
–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç,pub_1,pub_2,pub_3,...,closed_1,...,pen_1,pen_2,pen_3
–õ–∏–ø–µ—Ü–∫,3.0,4.5,3.0,...,6.0,...,-2.0,-1.0,-1.5
–ï–ª–µ—Ü,2.5,4.2,2.0,...,5.5,...,-1.5,0.0,-0.5
...
```

#### 2. Excel single-sheet (pre-calculated scores)
- –û–¥–∏–Ω –ª–∏—Å—Ç —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: –ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç, pub_1, pub_2, ..., pen_3
- –ó–Ω–∞—á–µ–Ω–∏—è = –≥–æ—Ç–æ–≤—ã–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –±–∞–ª–ª—ã

#### 3. Excel multi-sheet (raw data) - **–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø**
- –û–¥–∏–Ω –ª–∏—Å—Ç –Ω–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å
- –ù–∞–∑–≤–∞–Ω–∏—è –ª–∏—Å—Ç–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º:
  - "–û—Ü–µ–Ω–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –æ–±" ‚Üí pub_1
  - "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –ê–ì–ü" ‚Üí pub_2
  - –∏ —Ç.–¥. (–≤—Å–µ–≥–æ 16 –ª–∏—Å—Ç–æ–≤ –¥–ª—è 16 –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π)
- –°—Ç–æ–ª–±—Ü—ã –≤ –∫–∞–∂–¥–æ–º –ª–∏—Å—Ç–µ: –ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç, [raw data columns]
- **–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è IndicatorScorer –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏**

**–û—Ç–≤–µ—Ç**:
```json
{
  "status": "success",
  "message": "Official methodology data imported successfully!",
  "statistics": {
    "rows_processed": 20,
    "values_loaded": 300,
    "sheets_processed": 16,
    "format": "Excel (multi-sheet with IndicatorScorer)"
  },
  "period": "2024-01",
  "period_id": 27,
  "methodology": "Official 16 criteria",
  "next_steps": [
    "1. Hard refresh Rating tab (Ctrl+F5)",
    "2. Scores should display with proper aggregation"
  ]
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏**:
1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Ñ–∞–π–ª–∞ (CSV vs Excel)
2. –î–ª—è Excel –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç (single-sheet vs multi-sheet)
3. –î–ª—è multi-sheet: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **IndicatorScorer** –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤ –∏–∑ raw data
4. –î–ª—è pre-calculated: –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞–∫ –µ—Å—Ç—å
5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞–µ—Ç aggregated scores (–ü–£–ë–õ–ò–ß–ù–´–ô, –ó–ê–ö–†–´–¢–´–ô, –®—Ç—Ä–∞—Ñ—ã)
6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

---

## ‚ö†Ô∏è –°–¢–ê–†–´–ï –≠–ù–î–ü–û–ò–ù–¢–´ (Deprecated - –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)

### `POST /api/data-import/official-methodology`
**–°—Ç–∞—Ç—É—Å**: Deprecated
**–û–ø–∏—Å–∞–Ω–∏–µ**: –°—Ç–∞—Ä—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è CSV —Ñ–∞–π–ª–æ–≤
**–ü—Ä–∏—á–∏–Ω–∞ deprecation**: –ó–∞–º–µ–Ω–µ–Ω –Ω–∞ –µ–¥–∏–Ω—ã–π `/import-official-methodology`
**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –í—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø

### `POST /api/data-import/official-methodology-excel`
**–°—Ç–∞—Ç—É—Å**: Deprecated
**–û–ø–∏—Å–∞–Ω–∏–µ**: –°—Ç–∞—Ä—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è Excel —Ñ–∞–π–ª–æ–≤
**–ü—Ä–∏—á–∏–Ω–∞ deprecation**: –ó–∞–º–µ–Ω–µ–Ω –Ω–∞ –µ–¥–∏–Ω—ã–π `/import-official-methodology`
**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –í—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø

---

## üìã –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –í–∞—Ä–∏–∞–Ω—Ç 1: cURL (command line)

```bash
# Multi-sheet Excel (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
curl -X POST http://localhost:8000/api/data-import/import-official-methodology \
  -F "file=@data.xlsx" \
  -F "period_month=2024-01"

# CSV file
curl -X POST http://localhost:8000/api/data-import/import-official-methodology \
  -F "file=@data.csv" \
  -F "period_month=2024-01"
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Python (requests)

```python
import requests

# Upload Excel file
with open('data.xlsx', 'rb') as f:
    files = {'file': f}
    data = {'period_month': '2024-01'}
    response = requests.post(
        'http://localhost:8000/api/data-import/import-official-methodology',
        files=files,
        data=data
    )
    print(response.json())
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: JavaScript/Frontend

```javascript
const formData = new FormData()
formData.append('file', fileInput.files[0])
formData.append('period_month', '2024-01')

const response = await fetch(
  '/api/data-import/import-official-methodology',
  {
    method: 'POST',
    body: formData
  }
)
const result = await response.json()
console.log(result)
```

---

## üîç –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —Ä–∞—Å—á–µ—Ç–∞ (IndicatorScorer)

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç IndicatorScorer

–î–ª—è multi-sheet Excel —Ñ–∞–π–ª–æ–≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç **–≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç IndicatorScorer** –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤ –∏–∑ raw data.

**–ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–æ–≤**:

#### pub_1: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ (3 –¥–∞/–Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–∞)
```
Excel: –õ–∏–ø–µ—Ü–∫ | –î–∞ | –î–∞ | –î–∞
IndicatorScorer: count("–î–∞") = 3
Score = 3.0
```

#### pub_2: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –ê–ì–ü (%)
```
Excel: –õ–∏–ø–µ—Ü–∫ | 0.95
IndicatorScorer: 0.95 * 5 = 4.75
Score = 4.75
```

#### pub_7: –í–µ—Ç–µ—Ä–∞–Ω—ã (3 –º–µ—Ç—Ä–∏–∫–∏: –≤—Å—Ç—Ä–µ—á–∏, %, %)
```
Excel: –õ–∏–ø–µ—Ü–∫ | 40 | 0.85 | 0.75
IndicatorScorer:
  - –≤—Å—Ç—Ä–µ—á–∏ = 40/20 = 2.0 (max 1.0) = 1.0
  - —É—á–∞—Å—Ç–∏–µ = 0.85 * 1 = 0.85
  - —Ä–µ—à–µ–Ω–∏—è = 0.75 * 1 = 0.75
  - Total = 1.0 + 0.85 + 0.75 = 2.6
Score = 2.6
```

–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ 16 –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∏ –∏—Ö –ª–æ–≥–∏–∫–∞: —Å–º. `INDICATOR_SCORING_RULES.md`

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î**:
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±–∞–ª–ª—ã –ù–ï –Ω—É–ª–µ–≤—ã–µ
SELECT di.code, COUNT(*), AVG(fi.score)
FROM fact_indicator fi
JOIN dim_indicator di ON fi.ind_id = di.ind_id
GROUP BY di.code
ORDER BY di.code;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å aggregated scores
SELECT mo_id, score_public, score_closed, score_penalties, score_total, zone
FROM fact_summary
LIMIT 10;
```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ frontend**:
   - –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ https://reyting-alex1976.amvera.io/
   - –ù–∞–∂–∞—Ç—å Ctrl+Shift+R (hard refresh)
   - –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–†–µ–π—Ç–∏–Ω–≥"
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—Ç–æ–ª–±—Ü—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –Ω–µ–Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–µ 0.0)

---

## üêõ Troubleshooting

### –í—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ = 0.0
**–ü—Ä–∏—á–∏–Ω–∞**: –í–∞—à–µ —Å—Ç–∞—Ä–æ–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ä—ã–º —Å–ø–æ—Å–æ–±–æ–º
**–†–µ—à–µ–Ω–∏–µ**:
1. –û—á–∏—Å—Ç–∏—Ç—å –ë–î:
```sql
DELETE FROM fact_indicator;
DELETE FROM fact_summary;
```
2. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç

### "Municipality not found"
**–ü—Ä–∏—á–∏–Ω–∞**: –ù–∞–∑–≤–∞–Ω–∏—è –ú–û –≤ —Ñ–∞–π–ª–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –≤ –ë–î
**–†–µ—à–µ–Ω–∏–µ**:
```sql
SELECT mo_name FROM dim_mo ORDER BY mo_name;
```
–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏—è –≤ —Ñ–∞–π–ª–µ –¢–û–ß–ù–û —Å–æ–≤–ø–∞–¥–∞—é—Ç

### "Indicator not found"
**–ü—Ä–∏—á–∏–Ω–∞**: –î–ª—è single-sheet —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ (pub_1, closed_2, pen_3) –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç
**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–¥–æ–≤ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ multi-sheet —Ñ–æ—Ä–º–∞—Ç

---

## üìù –í–µ—Ä—Å–∏—è

- **–í–µ—Ä—Å–∏—è API**: 1.0.0 (Unified)
- **–î–∞—Ç–∞**: 2024-11-18
- **–°—Ç–∞—Ç—É—Å**: Production Ready
- **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã**: CSV, Excel (.xlsx, .xls)
- **–ì–∞—Ä–∞–Ω—Ç–∏—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏**: ‚úÖ IndicatorScorer –¥–ª—è multi-sheet —Ñ–æ—Ä–º–∞—Ç–∞
