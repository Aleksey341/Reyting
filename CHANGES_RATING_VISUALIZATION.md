# Изменения визуализации вкладки "Рейтинг"

## Описание

Произведена полная переделка визуализации вкладки "Рейтинг" с целью отображения рейтинга муниципальных образований в формате структурированной таблицы с подробной информацией о баллах за каждый критерий и штрафы.

## Что было изменено

### 1. Backend изменения

#### Файл: `backend/models.py`
- **Добавлено поле**: `leader_name` (VARCHAR(255)) в модель `DimMO`
- **Назначение**: Хранит ФИО главы муниципального образования
- **Пример значения**: "Ченцов Р.И."

#### Файл: `backend/routes/rating_routes.py`
- **Обновлен эндпоинт**: `GET /api/rating`
- **Новые данные в ответе**:
  - `leader_name`: ФИО главы МО
  - `indicators`: Словарь с баллами за каждый критерий (ключи: код показателя, значения: баллы)
  - `penalties`: Словарь с штрафами (ключи: код штрафа, значения: отрицательные баллы)

#### Новый файл: `backend/migrations/add_leader_name_to_mo.sql`
- Миграция для добавления колонки `leader_name` в таблицу `dim_mo`

### 2. Frontend изменения

#### Файл: `frontend/src/pages/RatingPage.jsx`
Полная переделка компонента с новой структурой таблицы:

**Структура таблицы:**
```
№ | Название МО | ФИО главы | [Баллы за критерии 1-17] | [Штрафы 18-21] | ИТОГ
```

**Новые возможности:**
1. **Два уровня заголовков**:
   - Первый уровень: категории (Баллы за критерии, Штрафы, ИТОГ)
   - Второй уровень: номера конкретных критериев и штрафов

2. **Цветовая дифференциация итога**:
   - Зелёный текст (53-66 баллов): Зелёная зона - высокая устойчивость
   - Оранжевый текст (29-52 баллов): Жёлтая зона - условная устойчивость
   - Красный текст (0-28 баллов): Красная зона - низкая устойчивость

3. **Модальное окно с описанием зон**:
   - Кнопка "ℹ️ Описание зон" в заголовке
   - Подробное описание каждой зоны с интерпретацией

4. **Визуальное разделение**:
   - Баллы за критерии: светло-голубой фон (bg-blue-50)
   - Штрафы: светло-красный фон (bg-red-50)
   - ИТОГ: светло-зелёный фон (bg-green-50)
   - Основные столбцы (№, МО, ФИО): белый фон

5. **Горизонтальная прокрутка**: Таблица полностью адаптирована для больших экранов с правильной прокруткой

## Пример API ответа

```json
{
  "status": "success",
  "total": 20,
  "page": 1,
  "page_size": 50,
  "data": [
    {
      "mo_id": 1,
      "mo_name": "Липецк",
      "leader_name": "Ченцов Р.И.",
      "score_public": 55.0,
      "score_closed": 15.0,
      "score_penalties": -2.0,
      "score_total": 68.0,
      "zone": "green",
      "indicators": {
        "1": 3,
        "2": 3,
        "3": 3,
        "4": 4,
        "5": 4,
        "6": 4,
        "7": 4,
        "8": 3,
        "9": 4,
        "10": 5,
        "11": 5,
        "12": 3,
        "13": 5,
        "14": 3,
        "15": 3,
        "16": 3,
        "17": 3
      },
      "penalties": {
        "penalty_18": 0,
        "penalty_19": -1,
        "penalty_20": 0,
        "penalty_21": 0
      },
      "updated_at": "2024-11-15T10:30:00"
    }
  ]
}
```

## Инструкции по применению

### 1. Обновление базы данных

Примените миграцию для добавления колонки `leader_name`:

```bash
# Подключитесь к PostgreSQL
psql -U postgres -d reyting_db -f backend/migrations/add_leader_name_to_mo.sql
```

Или используйте SQL:
```sql
ALTER TABLE dim_mo ADD COLUMN leader_name VARCHAR(255);
CREATE INDEX idx_dim_mo_leader_name ON dim_mo(leader_name);
```

### 2. Обновление данных в БД

Заполните поле `leader_name` для существующих МО (пример):

```sql
UPDATE dim_mo SET leader_name = 'Ченцов Р.И.' WHERE mo_name = 'Липецк';
UPDATE dim_mo SET leader_name = 'Жабин В.П.' WHERE mo_name = 'Елец';
-- ... и так далее для всех МО
```

### 3. Перезагрузка приложения

```bash
# Backend
cd backend
pip install -r requirements.txt  # если добавлены новые зависимости
python main.py

# Frontend
cd frontend
npm install  # если добавлены новые зависимости
npm run dev
```

## Описание зон в модальном окне

При клике на кнопку "ℹ️ Описание зон" выводится информация о трех зонах рейтинга:

### Зелёная зона (53-66 баллов)
**Высокая устойчивость** – Отставка маловероятна, глава МО обладает значительным ресурсом для управления и карьерного роста

### Жёлтая зона (29-52 баллов)
**Условная устойчивость** – Существуют риски, требующие коррекции управленческой или политической стратегии

### Красная зона (0-28 баллов)
**Низкая устойчивость** – Высокий риск отставки в среднесрочной перспективе, наличие серьёзных системных проблем

## Детали реализации

### Параметры (Критерии)
В текущей реализации используются следующие критерии (1-17):
- Критерии 1-17: Баллы за различные показатели деятельности МО

### Штрафы
Используются следующие штрафы (18-21):
- Штрафы 18-21: Штрафные баллы за нарушения

**Примечание**: Эти номера могут быть изменены на реальные коды показателей из системы, если требуется.

## Изменённые файлы

1. ✅ `backend/models.py` - добавлено поле `leader_name`
2. ✅ `backend/routes/rating_routes.py` - обновлен эндпоинт `/api/rating`
3. ✅ `frontend/src/pages/RatingPage.jsx` - полная переделка компонента
4. ✅ `backend/migrations/add_leader_name_to_mo.sql` - новая миграция БД

## Тестирование

### Проверка API
```bash
curl "http://localhost:8000/api/rating?period=2024-11&page=1"
```

Убедитесь, что в ответе присутствуют поля:
- `leader_name`
- `indicators` (словарь с кодами показателей)
- `penalties` (словарь с кодами штрафов)

### Проверка Frontend
1. Откройте приложение и перейдите на вкладку "Рейтинг"
2. Убедитесь, что таблица отображает:
   - Номер позиции (№)
   - Название МО
   - ФИО главы
   - Баллы за каждый критерий (1-17)
   - Штрафы (18-21)
   - Итоговый балл с цветовой дифференциацией
3. Нажмите кнопку "ℹ️ Описание зон" и проверьте модальное окно

## Возможные улучшения в будущем

1. **Динамическая загрузка критериев**: Вместо жестко закодированных номеров 1-17, можно загружать список критериев с бэка
2. **Сортировка по отдельным критериям**: Добавить возможность сортировки по конкретным параметрам
3. **Экспорт в Excel**: Добавить функцию экспорта таблицы рейтинга
4. **Детальный анализ**: По клику на строку показывать полный анализ показателей МО
5. **Сравнение МО**: Выбор нескольких МО для детального сравнения

## FAQ

**Q: Почему баллы показываются как целые числа, а не с десятичными?**
A: Это может быть изменено в коде в функции `getIndicatorScore()`. Если нужны десятичные: используйте `.toFixed(1)` вместо стандартного отображения.

**Q: Как добавить новые критерии?**
A: Добавьте новый объект в массив `parameterColumns` или `penaltyColumns` в компоненте `RatingPage.jsx`.

**Q: Где и как должны храниться коды показателей?**
A: Коды показателей должны храниться в таблице `dim_indicator` (код), а их баллы для МО - в таблице `fact_indicator`.
