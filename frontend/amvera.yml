# Amvera Configuration для Frontend
# Развёртывание React приложения на Amvera

---
version: 1

meta:
  name: "reyting-frontend"
  description: "React frontend for governance effectiveness dashboard"

# Используем Docker
env: docker
tool: docker

build:
  # Сборщик: docker
  tool: docker

  # Dockerfile находится в текущей папке (frontend/)
  dockerfile: Dockerfile

  # Контекст сборки - родительская папка
  context: ..

  # Аргументы сборки
  args:
    - name: REACT_APP_API_URL
      value: "https://api.reyting.amvera.ru/api"

# Конфигурация запуска контейнера
run:
  # Использовать собранный образ
  image: "${BUILD_IMAGE}"

  # Команда запуска (обычно переопределяется в Dockerfile)
  # Если используется nginx из Dockerfile - можно не указывать
  # command:
  #   - "serve"
  #   - "-s"
  #   - "build"
  #   - "-l"
  #   - "3000"

  # Постоянное хранилище (для React обычно не требуется)
  # persistenceMount: []

  # Порт контейнера (обычно 3000 для React)
  containerPort: 3000

  # Переменные окружения
  env:
    # API URL для фронтенда (должен быть доступен из браузера)
    - name: REACT_APP_API_URL
      value: "https://api.reyting.amvera.ru/api"

    # или используйте относительный путь
    # - name: REACT_APP_API_URL
    #   value: "/api"

    # Окружение
    - name: NODE_ENV
      value: "production"

  # Ресурсы контейнера (React требует меньше чем backend)
  resources:
    # Память (256Mi часто достаточно для React)
    memory: "256Mi"
    # CPU (0.25 = четверть ядра)
    cpu: "0.25"

  # Проверка здоровья контейнера
  healthcheck:
    # Проверяем доступность главной страницы
    path: /
    # Интервал между проверками (секунды)
    interval: 30
    # Таймаут одной проверки (секунды)
    timeout: 10
    # Сколько успешных проверок подряд
    successThreshold: 1
    # Сколько неудачных проверок подряд
    failureThreshold: 3

# Маршрутизация входящего трафика
routing:
  # Все остальные маршруты (за исключением /api) идут на frontend
  - path: "/"
    targetPort: 3000
    rewrite: "/"  # Переписываем на корень для React Router

# Домены
domains:
  - "reyting.amvera.ru"           # Основной домен
  - "www.reyting.amvera.ru"       # www версия

# Переменные с секретными данными (обычно для frontend не требуются)
# secrets: {}

# Логирование
logging:
  # Уровень логирования
  level: "INFO"
  # Формат
  format: "text"

# Лимиты и таймауты
limits:
  # Максимальное время на запуск контейнера (минуты)
  startupTimeout: 3  # React быстро стартует
  # Время на корректное завершение (секунды)
  gracefulShutdownTimeout: 10

# Бэкапы (для frontend обычно не требуются)
backups:
  enabled: false

# Автоскейлинг (опционально)
autoscaling:
  enabled: false
  # minReplicas: 1
  # maxReplicas: 5
  # targetCPUUtilization: 80

# CORS настройка
# Если frontend и backend на одном домене - CORS не требуется
# Иначе нужно настроить в backend (config.py)

# Кэширование статических файлов
# Автоматически настраивается в Dockerfile (nginx)

# Переменные окружения сборки (build time):
# REACT_APP_API_URL - устанавливается во время сборки
#
# Переменные окружения runtime (во время запуска):
# NODE_ENV=production

# Примечания:
# 1. Frontend использует Nginx (из multi-stage Dockerfile)
# 2. Статические файлы кэшируются браузером
# 3. React Router работает благодаря rewrite на /
# 4. API запросы идут на https://api.reyting.amvera.ru/api
